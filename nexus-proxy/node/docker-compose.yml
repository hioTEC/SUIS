version: '3.8'

services:
  caddy:
    image: caddy:2-alpine
    container_name: nexus-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    environment:
      - NODE_DOMAIN=${NODE_DOMAIN}
      - PATH_PREFIX=${PATH_PREFIX}
      - ACME_EMAIL=${ACME_EMAIL:-admin@example.com}
    volumes:
      - ./config/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
      - caddy-logs:/var/log/caddy
    networks:
      - nexus-net
    depends_on:
      - agent
      - singbox
      - adguard

  agent:
    build: .
    container_name: nexus-agent
    restart: unless-stopped
    environment:
      - CLUSTER_SECRET=${CLUSTER_SECRET}
      - NODE_DOMAIN=${NODE_DOMAIN}
      - CONFIG_DIR=/config
    volumes:
      - ./config:/config
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - nexus-net

  singbox:
    image: ghcr.io/sagernet/sing-box:latest
    container_name: nexus-singbox
    restart: unless-stopped
    volumes:
      - ./config/singbox:/etc/sing-box:ro
    networks:
      - nexus-net
    cap_add:
      - NET_ADMIN
    sysctls:
      - net.ipv4.ip_forward=1

  adguard:
    image: adguard/adguardhome:latest
    container_name: nexus-adguard
    restart: unless-stopped
    volumes:
      - adguard-work:/opt/adguardhome/work
      - adguard-conf:/opt/adguardhome/conf
    networks:
      - nexus-net
    ports:
      - "53:53/tcp"
      - "53:53/udp"

volumes:
  caddy-data:
  caddy-config:
  caddy-logs:
  adguard-work:
  adguard-conf:

networks:
  nexus-net:
    driver: bridge
