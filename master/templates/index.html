<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SUI Solo - Control Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #e2e8f0; min-height: 100vh; }
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid #334155; }
        h1 { font-size: 1.5rem; color: #38bdf8; }
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; transition: all 0.2s; text-decoration: none; display: inline-flex; align-items: center; gap: 0.375rem; }
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-success { background: #22c55e; color: white; }
        .btn-success:hover { background: #16a34a; }
        .btn-warning { background: #f59e0b; color: white; }
        .btn-warning:hover { background: #d97706; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.75rem; }
        .btn-outline { background: transparent; border: 1px solid #475569; color: #94a3b8; }
        .btn-outline:hover { background: #334155; color: #e2e8f0; }
        .card { background: #1e293b; border-radius: 0.75rem; padding: 1.5rem; margin-bottom: 1rem; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .node-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 1.5rem; }
        .node-card { background: #1e293b; border-radius: 0.75rem; padding: 1.5rem; border: 1px solid #334155; transition: border-color 0.2s; }
        .node-card:hover { border-color: #3b82f6; }
        .node-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
        .node-name { font-weight: 600; font-size: 1.25rem; }
        .node-domain { color: #94a3b8; font-size: 0.875rem; margin-top: 0.25rem; }
        .node-domain a { color: #38bdf8; text-decoration: none; }
        .node-domain a:hover { text-decoration: underline; }
        .status { display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 500; }
        .status-online { background: #166534; color: #86efac; }
        .status-offline { background: #991b1b; color: #fca5a5; }
        .status-unknown { background: #374151; color: #9ca3af; }
        .status::before { content: ''; width: 6px; height: 6px; border-radius: 50%; }
        .status-online::before { background: #86efac; }
        .status-offline::before { background: #fca5a5; }
        .status-unknown::before { background: #9ca3af; }
        .services-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.75rem; margin: 1rem 0; }
        .service-item { background: #0f172a; padding: 0.75rem; border-radius: 0.5rem; text-align: center; }
        .service-name { font-size: 0.75rem; color: #94a3b8; margin-bottom: 0.25rem; }
        .service-status { font-size: 0.875rem; font-weight: 500; }
        .service-status.running { color: #86efac; }
        .service-status.stopped { color: #fca5a5; }
        .quick-links { display: flex; gap: 0.5rem; flex-wrap: wrap; margin: 1rem 0; padding: 1rem 0; border-top: 1px solid #334155; }
        .quick-link { display: inline-flex; align-items: center; gap: 0.375rem; padding: 0.5rem 0.75rem; background: #334155; border-radius: 0.375rem; color: #e2e8f0; text-decoration: none; font-size: 0.8125rem; transition: background 0.2s; }
        .quick-link:hover { background: #475569; }
        .quick-link-icon { font-size: 1rem; }
        .actions { display: flex; gap: 0.5rem; flex-wrap: wrap; padding-top: 1rem; border-top: 1px solid #334155; }
        .node-info { font-size: 0.75rem; color: #64748b; margin-top: 0.5rem; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.75); align-items: center; justify-content: center; z-index: 50; }
        .modal.active { display: flex; }
        .modal-content { background: #1e293b; padding: 2rem; border-radius: 0.75rem; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .modal-close { background: none; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer; }
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-size: 0.875rem; color: #94a3b8; }
        .form-group input, .form-group textarea { width: 100%; padding: 0.75rem; background: #0f172a; border: 1px solid #334155; border-radius: 0.375rem; color: #e2e8f0; font-family: inherit; }
        .form-group textarea { min-height: 200px; font-family: monospace; font-size: 0.8125rem; }
        .form-actions { display: flex; gap: 0.5rem; justify-content: flex-end; margin-top: 1.5rem; }
        .empty-state { text-align: center; padding: 4rem 2rem; color: #64748b; }
        .empty-state h3 { color: #94a3b8; margin-bottom: 0.5rem; }
        .https-badge { background: #166534; color: #86efac; padding: 0.125rem 0.5rem; border-radius: 0.25rem; font-size: 0.625rem; margin-left: 0.5rem; }
        .loading { opacity: 0.5; pointer-events: none; }
        .toast { position: fixed; bottom: 2rem; right: 2rem; padding: 1rem 1.5rem; border-radius: 0.5rem; color: white; z-index: 100; animation: slideIn 0.3s; }
        .toast-success { background: #166534; }
        .toast-error { background: #991b1b; }
        @keyframes slideIn { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üöÄ SUI Solo <span class="https-badge">v{{ version }}</span></h1>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <button class="btn btn-outline" onclick="showSubscribeModal()">üìã Subscribe</button>
                <button class="btn btn-outline" onclick="showSettingsModal()">‚öôÔ∏è Settings</button>
                <button class="btn btn-primary" onclick="showAddModal()">+ Add Node</button>
            </div>
        </header>

        <!-- Quick Actions Card -->
        <div class="card" style="margin-bottom: 1.5rem;">
            <div class="card-header">
                <h2>üîß System Controls</h2>
            </div>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                <button class="btn btn-success btn-sm" onclick="rebuildMaster()">üîÑ Rebuild Master</button>
                <button class="btn btn-success btn-sm" onclick="rebuildGateway()">üåê Rebuild Gateway</button>
                <button class="btn btn-warning btn-sm" onclick="updateMaster()">‚¨ÜÔ∏è Update Master</button>
                <button class="btn btn-warning btn-sm" onclick="updateAllNodes()">‚¨ÜÔ∏è Update All Nodes</button>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h2>Nodes ({{ nodes|length }})</h2>
                <button class="btn btn-outline btn-sm" onclick="refreshAll()">‚Üª Refresh All</button>
            </div>
            
            <div class="node-grid" id="nodeGrid">
                {% if not nodes %}
                <div class="empty-state" style="grid-column: 1/-1;">
                    <h3>No nodes configured</h3>
                    <p>Click "Add Node" to connect your first proxy node.</p>
                </div>
                {% endif %}
                
                {% for id, node in nodes.items() %}
                <div class="node-card" id="node-{{ id }}">
                    <div class="node-header">
                        <div>
                            <div class="node-name">{{ node.name }}</div>
                            <div class="node-domain">
                                <a href="https://{{ node.domain }}" target="_blank">{{ node.domain }}</a>
                            </div>
                        </div>
                        <span class="status status-{{ node.status }}" id="status-{{ id }}">{{ node.status }}</span>
                    </div>
                    
                    <div class="services-grid" id="services-{{ id }}">
                        <div class="service-item">
                            <div class="service-name">Sing-box</div>
                            <div class="service-status" id="svc-{{ id }}-singbox">--</div>
                        </div>
                        <div class="service-item">
                            <div class="service-name">AdGuard</div>
                            <div class="service-status" id="svc-{{ id }}-adguard">--</div>
                        </div>
                        <div class="service-item">
                            <div class="service-name">Caddy</div>
                            <div class="service-status" id="svc-{{ id }}-caddy">--</div>
                        </div>
                    </div>
                    
                    <div class="quick-links">
                        <a href="https://{{ node.domain }}/adguard/" target="_blank" class="quick-link">
                            <span class="quick-link-icon">üõ°Ô∏è</span> AdGuard Home
                        </a>
                        <a href="https://{{ node.domain }}" target="_blank" class="quick-link">
                            <span class="quick-link-icon">üåê</span> Node URL
                        </a>
                    </div>
                    
                    <div class="actions">
                        <button class="btn btn-primary btn-sm" onclick="checkStatus('{{ id }}')">Check Status</button>
                        <button class="btn btn-outline btn-sm" onclick="showConfigModal('{{ id }}', 'singbox')">Config</button>
                        <button class="btn btn-outline btn-sm" onclick="showLogsModal('{{ id }}')">Logs</button>
                        <button class="btn btn-success btn-sm" onclick="rebuildNode('{{ id }}')">Rebuild</button>
                        <button class="btn btn-warning btn-sm" onclick="updateNode('{{ id }}')">Update</button>
                        <button class="btn btn-danger btn-sm" onclick="deleteNode('{{ id }}')">Delete</button>
                    </div>
                    
                    <div class="node-info">
                        Added: {{ node.added_at[:10] if node.added_at else 'Unknown' }}
                        {% if node.last_check %} | Last check: {{ node.last_check[11:19] }}{% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Add Node Modal -->
    <div class="modal" id="addModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Node</h3>
                <button class="modal-close" onclick="hideModal('addModal')">&times;</button>
            </div>
            <form id="addForm">
                <div class="form-group">
                    <label>Node Name</label>
                    <input type="text" name="name" placeholder="e.g., Tokyo-01" required>
                </div>
                <div class="form-group">
                    <label>Domain</label>
                    <input type="text" name="domain" placeholder="e.g., node1.example.com" required>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="hideModal('addModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Node</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Subscribe Modal -->
    <div class="modal" id="subscribeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìã Subscription Links</h3>
                <button class="modal-close" onclick="hideModal('subscribeModal')">&times;</button>
            </div>
            <div class="form-group">
                <label>Base64 (v2rayN, Shadowrocket)</label>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="subBase64" readonly style="flex: 1;">
                    <button class="btn btn-sm btn-primary" onclick="copyToClipboard('subBase64')">Copy</button>
                </div>
            </div>
            <div class="form-group">
                <label>Clash Format</label>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="subClash" readonly style="flex: 1;">
                    <button class="btn btn-sm btn-primary" onclick="copyToClipboard('subClash')">Copy</button>
                </div>
            </div>
            <div class="form-group">
                <label>Sing-box Format</label>
                <div style="display: flex; gap: 0.5rem;">
                    <input type="text" id="subSingbox" readonly style="flex: 1;">
                    <button class="btn btn-sm btn-primary" onclick="copyToClipboard('subSingbox')">Copy</button>
                </div>
            </div>
            <p style="font-size: 0.75rem; color: #64748b; margin-top: 1rem;">
                üí° Copy the subscription link and paste it into your proxy client.
            </p>
        </div>
    </div>

    <!-- Config Modal -->
    <div class="modal" id="configModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 id="configTitle">Configuration</h3>
                <button class="modal-close" onclick="hideModal('configModal')">&times;</button>
            </div>
            <form id="configForm">
                <input type="hidden" name="nodeId" id="configNodeId">
                <input type="hidden" name="service" id="configService">
                
                <!-- Template Selection (only for singbox) -->
                <div class="form-group" id="templateSection" style="display: none;">
                    <label>Quick Templates</label>
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 0.5rem;">
                        <button type="button" class="btn btn-sm btn-outline" onclick="loadTemplate('vless-reality')">VLESS+Reality</button>
                        <button type="button" class="btn btn-sm btn-outline" onclick="loadTemplate('vless-ws')">VLESS+WS</button>
                        <button type="button" class="btn btn-sm btn-outline" onclick="loadTemplate('vmess-ws')">VMess+WS</button>
                        <button type="button" class="btn btn-sm btn-outline" onclick="loadTemplate('hysteria2')">Hysteria2</button>
                        <button type="button" class="btn btn-sm btn-outline" onclick="loadTemplate('trojan')">Trojan</button>
                    </div>
                    <p style="font-size: 0.7rem; color: #64748b;">Click a template to auto-fill. Edit UUID/domain as needed.</p>
                </div>
                
                <div class="form-group">
                    <label>Config Content</label>
                    <textarea name="content" id="configContent" placeholder="Loading..." style="min-height: 300px;"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-outline" onclick="hideModal('configModal')">Cancel</button>
                    <button type="button" class="btn btn-warning" onclick="restartService()">Restart Service</button>
                    <button type="submit" class="btn btn-primary">Save & Restart</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚öôÔ∏è Settings</h3>
                <button class="modal-close" onclick="hideModal('settingsModal')">&times;</button>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                    <input type="checkbox" id="autoUpdateToggle" onchange="toggleAutoUpdate()" style="width: auto;">
                    Enable Auto Update Check
                </label>
                <p style="font-size: 0.75rem; color: #64748b; margin-top: 0.5rem;">Automatically check for updates periodically</p>
            </div>
            <div style="border-top: 1px solid #334155; padding-top: 1rem; margin-top: 1rem;">
                <h4 style="margin-bottom: 1rem;">Manual Update</h4>
                <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button class="btn btn-outline" onclick="checkForUpdates()">Check for Updates</button>
                    <button class="btn btn-warning" onclick="updateMaster()">Update Master</button>
                    <button class="btn btn-warning" onclick="updateAllNodes()">Update All Nodes</button>
                </div>
                <p id="updateStatus" style="font-size: 0.75rem; color: #64748b; margin-top: 0.5rem;"></p>
            </div>
            <div style="border-top: 1px solid #334155; padding-top: 1rem; margin-top: 1rem;">
                <p style="font-size: 0.75rem; color: #64748b;">
                    Current Version: <strong>{{ version }}</strong><br>
                    Last Check: <span id="lastCheck">{{ settings.last_update_check or 'Never' }}</span>
                </p>
            </div>
        </div>
    </div>

    <!-- Logs Modal -->
    <div class="modal" id="logsModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Logs</h3>
                <button class="modal-close" onclick="hideModal('logsModal')">&times;</button>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                <button class="btn btn-sm btn-outline" onclick="loadLogs(currentLogNode, 'singbox')">Sing-box</button>
                <button class="btn btn-sm btn-outline" onclick="loadLogs(currentLogNode, 'adguard')">AdGuard</button>
                <button class="btn btn-sm btn-outline" onclick="loadLogs(currentLogNode, 'caddy')">Caddy</button>
            </div>
            <pre id="logsContent" style="background: #0f172a; padding: 1rem; border-radius: 0.5rem; overflow: auto; max-height: 400px; font-size: 0.75rem; color: #94a3b8;">Select a service to view logs</pre>
        </div>
    </div>

    <script>
        let currentLogNode = null;

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function showAddModal() { document.getElementById('addModal').classList.add('active'); }
        function hideModal(id) { document.getElementById(id).classList.remove('active'); }

        async function showSubscribeModal() {
            document.getElementById('subscribeModal').classList.add('active');
            try {
                const resp = await fetch('/api/subscribe/url');
                const data = await resp.json();
                document.getElementById('subBase64').value = data.base64 || '';
                document.getElementById('subClash').value = data.clash || '';
                document.getElementById('subSingbox').value = data.singbox || '';
            } catch (err) {
                showToast('Failed to load subscription URLs', 'error');
            }
        }

        function copyToClipboard(elementId) {
            const el = document.getElementById(elementId);
            el.select();
            document.execCommand('copy');
            showToast('Copied to clipboard!');
        }

        async function rebuildMaster() {
            if (!confirm('Rebuild Master container? This will restart the control panel.')) return;
            showToast('Rebuilding Master...');
            try {
                const resp = await fetch('/api/master/rebuild', {method: 'POST'});
                const data = await resp.json();
                showToast(data.success ? 'Master rebuild initiated. Page will reload...' : `Failed: ${data.error}`, data.success ? 'success' : 'error');
                if (data.success) setTimeout(() => location.reload(), 10000);
            } catch (err) {
                showToast('Rebuild failed', 'error');
            }
        }

        async function rebuildGateway() {
            if (!confirm('Rebuild Gateway container? This may briefly interrupt HTTPS.')) return;
            showToast('Rebuilding Gateway...');
            try {
                const resp = await fetch('/api/gateway/rebuild', {method: 'POST'});
                const data = await resp.json();
                showToast(data.success ? 'Gateway rebuilt successfully' : `Failed: ${data.error}`, data.success ? 'success' : 'error');
            } catch (err) {
                showToast('Rebuild failed', 'error');
            }
        }

        document.getElementById('addForm').onsubmit = async (e) => {
            e.preventDefault();
            const form = new FormData(e.target);
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true;
            btn.textContent = 'Adding...';
            
            try {
                const resp = await fetch('/api/nodes', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name: form.get('name'), domain: form.get('domain')})
                });
                if (resp.ok) {
                    showToast('Node added successfully');
                    location.reload();
                } else {
                    const data = await resp.json();
                    showToast(data.error || 'Failed to add node', 'error');
                }
            } catch (err) {
                showToast('Network error', 'error');
            }
            btn.disabled = false;
            btn.textContent = 'Add Node';
        };

        async function checkStatus(id) {
            const statusEl = document.getElementById(`status-${id}`);
            statusEl.textContent = 'checking...';
            statusEl.className = 'status status-unknown';
            
            try {
                const resp = await fetch(`/api/nodes/${id}/status`);
                const data = await resp.json();
                
                if (data.error) {
                    statusEl.textContent = 'offline';
                    statusEl.className = 'status status-offline';
                    showToast(`Node offline: ${data.error}`, 'error');
                } else {
                    statusEl.textContent = 'online';
                    statusEl.className = 'status status-online';
                    showToast(`Online - Uptime: ${data.uptime || 'N/A'}`);
                }
                
                // Load services
                loadServices(id);
            } catch (err) {
                statusEl.textContent = 'error';
                statusEl.className = 'status status-offline';
                showToast('Failed to check status', 'error');
            }
        }

        async function loadServices(id) {
            try {
                const resp = await fetch(`/api/nodes/${id}/services`);
                const data = await resp.json();
                
                if (data.services) {
                    for (const [svc, status] of Object.entries(data.services)) {
                        const el = document.getElementById(`svc-${id}-${svc}`);
                        if (el) {
                            el.textContent = status;
                            el.className = `service-status ${status === 'running' ? 'running' : 'stopped'}`;
                        }
                    }
                }
            } catch (err) {
                console.error('Failed to load services:', err);
            }
        }

        async function refreshAll() {
            const nodes = document.querySelectorAll('.node-card');
            for (const node of nodes) {
                const id = node.id.replace('node-', '');
                await checkStatus(id);
            }
        }

        async function showConfigModal(nodeId, service) {
            document.getElementById('configNodeId').value = nodeId;
            document.getElementById('configService').value = service;
            document.getElementById('configTitle').textContent = `${service} Configuration`;
            document.getElementById('configContent').value = 'Loading...';
            document.getElementById('configModal').classList.add('active');
            
            // Show template section only for singbox
            document.getElementById('templateSection').style.display = service === 'singbox' ? 'block' : 'none';
            
            try {
                const resp = await fetch(`/api/nodes/${nodeId}/config/${service}`);
                const data = await resp.json();
                document.getElementById('configContent').value = data.content || data.error || 'No config found';
            } catch (err) {
                document.getElementById('configContent').value = 'Failed to load config';
            }
        }

        // Sing-box config templates
        const TEMPLATES = {
            'vless-reality': {
                "log": {"level": "info"},
                "inbounds": [{
                    "type": "vless",
                    "tag": "vless-in",
                    "listen": "::",
                    "listen_port": 443,
                    "users": [{"uuid": "YOUR-UUID-HERE", "flow": "xtls-rprx-vision"}],
                    "tls": {
                        "enabled": true,
                        "server_name": "www.microsoft.com",
                        "reality": {
                            "enabled": true,
                            "handshake": {"server": "www.microsoft.com", "server_port": 443},
                            "private_key": "YOUR-PRIVATE-KEY",
                            "short_id": ["abcd1234"]
                        }
                    }
                }],
                "outbounds": [{"type": "direct", "tag": "direct"}]
            },
            'vless-ws': {
                "log": {"level": "info"},
                "inbounds": [{
                    "type": "vless",
                    "tag": "vless-ws-in",
                    "listen": "::",
                    "listen_port": 443,
                    "users": [{"uuid": "YOUR-UUID-HERE"}],
                    "transport": {"type": "ws", "path": "/vless"},
                    "tls": {"enabled": true, "server_name": "YOUR-DOMAIN"}
                }],
                "outbounds": [{"type": "direct", "tag": "direct"}]
            },
            'vmess-ws': {
                "log": {"level": "info"},
                "inbounds": [{
                    "type": "vmess",
                    "tag": "vmess-ws-in",
                    "listen": "::",
                    "listen_port": 443,
                    "users": [{"uuid": "YOUR-UUID-HERE"}],
                    "transport": {"type": "ws", "path": "/vmess"},
                    "tls": {"enabled": true, "server_name": "YOUR-DOMAIN"}
                }],
                "outbounds": [{"type": "direct", "tag": "direct"}]
            },
            'hysteria2': {
                "log": {"level": "info"},
                "inbounds": [{
                    "type": "hysteria2",
                    "tag": "hy2-in",
                    "listen": "::",
                    "listen_port": 443,
                    "users": [{"password": "YOUR-PASSWORD-HERE"}],
                    "tls": {"enabled": true, "server_name": "YOUR-DOMAIN"}
                }],
                "outbounds": [{"type": "direct", "tag": "direct"}]
            },
            'trojan': {
                "log": {"level": "info"},
                "inbounds": [{
                    "type": "trojan",
                    "tag": "trojan-in",
                    "listen": "::",
                    "listen_port": 443,
                    "users": [{"password": "YOUR-PASSWORD-HERE"}],
                    "tls": {"enabled": true, "server_name": "YOUR-DOMAIN"}
                }],
                "outbounds": [{"type": "direct", "tag": "direct"}]
            }
        };

        function loadTemplate(name) {
            if (TEMPLATES[name]) {
                const config = JSON.parse(JSON.stringify(TEMPLATES[name]));
                // Auto-fill with a generated UUID
                const uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                    const r = Math.random() * 16 | 0;
                    return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
                });
                const configStr = JSON.stringify(config, null, 2)
                    .replace(/YOUR-UUID-HERE/g, uuid)
                    .replace(/YOUR-PASSWORD-HERE/g, uuid.replace(/-/g, '').substring(0, 16));
                document.getElementById('configContent').value = configStr;
                showToast(`Loaded ${name} template. Edit domain/keys as needed.`);
            }
        }

        document.getElementById('configForm').onsubmit = async (e) => {
            e.preventDefault();
            const nodeId = document.getElementById('configNodeId').value;
            const service = document.getElementById('configService').value;
            const content = document.getElementById('configContent').value;
            
            try {
                // Save config
                await fetch(`/api/nodes/${nodeId}/config/${service}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({content})
                });
                
                // Restart service
                await fetch(`/api/nodes/${nodeId}/restart/${service}`, {method: 'POST'});
                
                showToast('Config saved and service restarted');
                hideModal('configModal');
            } catch (err) {
                showToast('Failed to save config', 'error');
            }
        };

        async function restartService() {
            const nodeId = document.getElementById('configNodeId').value;
            const service = document.getElementById('configService').value;
            
            try {
                const resp = await fetch(`/api/nodes/${nodeId}/restart/${service}`, {method: 'POST'});
                const data = await resp.json();
                showToast(data.success ? 'Service restarted' : `Failed: ${data.message}`, data.success ? 'success' : 'error');
            } catch (err) {
                showToast('Failed to restart service', 'error');
            }
        }

        function showLogsModal(nodeId) {
            currentLogNode = nodeId;
            document.getElementById('logsContent').textContent = 'Select a service to view logs';
            document.getElementById('logsModal').classList.add('active');
        }

        async function loadLogs(nodeId, service) {
            document.getElementById('logsContent').textContent = 'Loading...';
            
            try {
                const resp = await fetch(`/api/nodes/${nodeId}/logs/${service}?lines=100`);
                const data = await resp.json();
                document.getElementById('logsContent').textContent = data.logs || data.error || 'No logs';
            } catch (err) {
                document.getElementById('logsContent').textContent = 'Failed to load logs';
            }
        }

        async function deleteNode(id) {
            if (!confirm('Are you sure you want to delete this node?')) return;
            
            try {
                const resp = await fetch(`/api/nodes/${id}`, {method: 'DELETE'});
                if (resp.ok) {
                    showToast('Node deleted');
                    location.reload();
                } else {
                    showToast('Failed to delete node', 'error');
                }
            } catch (err) {
                showToast('Network error', 'error');
            }
        }

        // Update functions
        async function updateNode(id) {
            if (!confirm('Update this node? This will restart services.')) return;
            showToast('Updating node...');
            try {
                const resp = await fetch(`/api/nodes/${id}/update`, {method: 'POST'});
                const data = await resp.json();
                showToast(data.success ? 'Node updated successfully' : `Update failed: ${data.error}`, data.success ? 'success' : 'error');
            } catch (err) {
                showToast('Update failed', 'error');
            }
        }

        async function rebuildNode(id) {
            if (!confirm('Rebuild all containers on this node? This will restart all services.')) return;
            showToast('Rebuilding node containers...');
            try {
                const resp = await fetch(`/api/nodes/${id}/rebuild`, {method: 'POST'});
                const data = await resp.json();
                showToast(data.success ? 'Node rebuilt successfully' : `Rebuild failed: ${data.error || data.output}`, data.success ? 'success' : 'error');
                if (data.success) {
                    setTimeout(() => checkStatus(id), 5000);
                }
            } catch (err) {
                showToast('Rebuild failed', 'error');
            }
        }

        function showSettingsModal() {
            document.getElementById('settingsModal').classList.add('active');
            loadSettings();
        }

        async function loadSettings() {
            try {
                const resp = await fetch('/api/settings');
                const data = await resp.json();
                document.getElementById('autoUpdateToggle').checked = data.auto_update;
            } catch (err) {}
        }

        async function toggleAutoUpdate() {
            const enabled = document.getElementById('autoUpdateToggle').checked;
            try {
                await fetch('/api/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({auto_update: enabled})
                });
                showToast(`Auto update ${enabled ? 'enabled' : 'disabled'}`);
            } catch (err) {
                showToast('Failed to save setting', 'error');
            }
        }

        async function checkForUpdates() {
            document.getElementById('updateStatus').textContent = 'Checking...';
            try {
                const resp = await fetch('/api/update/check');
                const data = await resp.json();
                if (data.update_available) {
                    document.getElementById('updateStatus').innerHTML = `<span style="color: #f59e0b;">Update available: ${data.latest}</span>`;
                } else {
                    document.getElementById('updateStatus').innerHTML = `<span style="color: #22c55e;">You're up to date (${data.current})</span>`;
                }
            } catch (err) {
                document.getElementById('updateStatus').textContent = 'Check failed';
            }
        }

        async function updateMaster() {
            if (!confirm('Update Master? You may need to restart the container after.')) return;
            showToast('Updating master...');
            try {
                const resp = await fetch('/api/update/master', {method: 'POST'});
                const data = await resp.json();
                showToast(data.success ? 'Master updated. Restart container to apply.' : `Failed: ${data.error}`, data.success ? 'success' : 'error');
            } catch (err) {
                showToast('Update failed', 'error');
            }
        }

        async function updateAllNodes() {
            if (!confirm('Update all nodes? This will restart services on all nodes.')) return;
            showToast('Updating all nodes...');
            try {
                const resp = await fetch('/api/update/all-nodes', {method: 'POST'});
                const data = await resp.json();
                const success = Object.values(data).filter(r => r.success).length;
                const total = Object.keys(data).length;
                showToast(`Updated ${success}/${total} nodes`);
            } catch (err) {
                showToast('Update failed', 'error');
            }
        }

        // Auto-refresh status on page load
        document.addEventListener('DOMContentLoaded', () => {
            const nodes = document.querySelectorAll('.node-card');
            nodes.forEach(node => {
                const id = node.id.replace('node-', '');
                loadServices(id);
            });
        });
    </script>
</body>
</html>
