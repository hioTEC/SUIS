version: '3.8'

services:
  caddy:
    image: caddy:2-alpine
    container_name: sui-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
      - "443:443/udp"
    volumes:
      - ./config/caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
      - caddy-logs:/var/log/caddy
    networks:
      - sui-net
    depends_on:
      - agent

  agent:
    build: .
    container_name: sui-agent
    restart: unless-stopped
    environment:
      - CLUSTER_SECRET=${CLUSTER_SECRET}
      - NODE_DOMAIN=${NODE_DOMAIN}
      - CONFIG_DIR=/config
    volumes:
      - ./config:/config
      # SECURITY: Use docker-proxy instead of direct socket access
      # This limits commands to a whitelist
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - sui-net
    # Security: Run as non-root user
    # user: "1000:1000"  # Uncomment if your setup supports it
    # Security: Read-only root filesystem
    read_only: true
    tmpfs:
      - /tmp
    # Security: Drop all capabilities except what's needed
    cap_drop:
      - ALL
    security_opt:
      - no-new-privileges:true

  singbox:
    image: ghcr.io/sagernet/sing-box:latest
    container_name: sui-singbox
    restart: unless-stopped
    volumes:
      - ./config/singbox:/etc/sing-box:ro
    networks:
      - sui-net
    cap_add:
      - NET_ADMIN
    cap_drop:
      - ALL

  adguard:
    image: adguard/adguardhome:latest
    container_name: sui-adguard
    restart: unless-stopped
    volumes:
      - adguard-work:/opt/adguardhome/work
      - adguard-conf:/opt/adguardhome/conf
    networks:
      - sui-net
    ports:
      - "53:53/tcp"
      - "53:53/udp"
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
      - CHOWN
      - SETUID
      - SETGID

volumes:
  caddy-data:
  caddy-config:
  caddy-logs:
  adguard-work:
  adguard-conf:

networks:
  sui-net:
    driver: bridge
